# Auticuro ç³»ç»Ÿæ¶æ„ä¸å®ç°æ·±åº¦åˆ†æ

> **åˆ†ææ—¥æœŸ**: 2025å¹´12æœˆ11æ—¥  
> **é¡¹ç›®ç‰ˆæœ¬**: åŸºäºå½“å‰ä»£ç åº“åˆ†æ  
> **åˆ†æèŒƒå›´**: Command Side (firm-wallet-service, firm-wallet-gateway, tiny-mq)

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°ä¸æ ¸å¿ƒä»·å€¼](#1-é¡¹ç›®æ¦‚è¿°ä¸æ ¸å¿ƒä»·å€¼)
2. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#2-ç³»ç»Ÿæ¶æ„è®¾è®¡)
3. [å…³é”®æµç¨‹åˆ†æ](#3-å…³é”®æµç¨‹åˆ†æ)
4. [æºç çº§è®¾è®¡äº®ç‚¹](#4-æºç çº§è®¾è®¡äº®ç‚¹)
5. [æŠ€æœ¯æ ˆæ€»ç»“](#5-æŠ€æœ¯æ ˆæ€»ç»“)
6. [æ€»ç»“ä¸å¯ç¤º](#6-æ€»ç»“ä¸å¯ç¤º)

---

## 1. é¡¹ç›®æ¦‚è¿°ä¸æ ¸å¿ƒä»·å€¼

### 1.1 é¡¹ç›®ç®€ä»‹

**Auticuro**ï¼ˆæºè‡ªæ‹‰ä¸è¯­ Au = é»„é‡‘ + æ„å¤§åˆ©è¯­ Curo = ä¿æŠ¤ï¼‰æ˜¯ä¸€ä¸ª**é«˜æ€§èƒ½ã€å¼ºä¸€è‡´æ€§ã€åˆ†å¸ƒå¼é’±åŒ…æœåŠ¡**ï¼Œä¸“ä¸ºé‡‘èå…³é”®ä»»åŠ¡åº”ç”¨è®¾è®¡ã€‚

### 1.2 æ ¸å¿ƒè§£å†³ç—›ç‚¹

| ç—›ç‚¹ | Auticuro è§£å†³æ–¹æ¡ˆ |
|------|------------------|
| **èµ„é‡‘è½¬ç§»çš„ç²¾ç¡®ä¸€æ¬¡æ€§è¯­ä¹‰** | åŸºäº `dedup_id` çš„å¹‚ç­‰æ€§æœºåˆ¶ + Event Sourcing |
| **åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å¼ºä¸€è‡´æ€§** | åŸºäº Raft å…±è¯†ç®—æ³•çš„é›†ç¾¤å¤åˆ¶ |
| **é«˜ååä½å»¶è¿Ÿ** | å•çº¿ç¨‹æ— é”å…³é”®è·¯å¾„ + CQRS è¯»å†™åˆ†ç¦» |
| **é«˜å¯ç”¨å®¹é”™** | 5 èŠ‚ç‚¹é›†ç¾¤ï¼ŒRTO â‰¤ 4sï¼Œæ”¯æŒå¤šæ•°èŠ‚ç‚¹æ•…éšœ |
| **å¤æ‚åˆ†å¸ƒå¼äº‹åŠ¡** | æ”¯æŒ TCC/SAGA æ¨¡å¼çš„åŸå­æ‰¹é‡ä½™é¢æ“ä½œ |

### 1.3 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | æµ‹è¯•ç¯å¢ƒ |
|------|------|----------|
| **TPS** | 10,000+ | 5èŠ‚ç‚¹ GCP é›†ç¾¤ (8 vCPU/èŠ‚ç‚¹) |
| **P99 å»¶è¿Ÿ** | < 20ms | SSD æŒä¹…åŒ–ç£ç›˜ |
| **RTO** | â‰¤ 4 ç§’ | Leader æ•…éšœåˆ‡æ¢ |
| **å¹¶å‘æ¨¡å‹** | æ— é”è®¾è®¡ | å•çº¿ç¨‹å…³é”®è·¯å¾„ |

### 1.4 é€‚ç”¨åœºæ™¯

- **ç”µå•†å¹³å°**: é«˜å¹¶å‘æ”¯ä»˜æ¸…ç»“ç®—
- **åŠ å¯†è´§å¸é’±åŒ…**: å¤šèµ„äº§ç±»åˆ«ç®¡ç†
- **é‡‘èç§‘æŠ€åº”ç”¨**: è´¦æˆ·ç®¡ç†ä¸äº¤æ˜“è¿½è¸ª
- **é“¶è¡Œç³»ç»Ÿ**: æ ¸å¿ƒè´¦åŠ¡å¼•æ“
- **å¿ è¯šåº¦/ç§¯åˆ†ç³»ç»Ÿ**: è·¨ä¸šåŠ¡ç§¯åˆ†ç®¡ç†
- **è·¨å¢ƒæ±‡æ¬¾**: åŸå­è·¨è´¦æˆ·è½¬è´¦

### 1.5 åŠŸèƒ½ç‰¹æ€§

**åŠŸèƒ½æ€§ç‰¹æ€§**:
- âœ… åŒè¾¹èµ„é‡‘è½¬è´¦ (Bilateral Transfer)
- âœ… æ‰¹é‡ä½™é¢æ“ä½œ (åŸå­æ€§å¢å‡å¤šè´¦æˆ·ä½™é¢)
- âœ… è´¦æˆ·ç®¡ç† (åˆ›å»º/åˆ é™¤/é”å®š/è§£é”)
- âœ… ä½™é¢é™åˆ¶é…ç½® (ä¸Šä¸‹é™)
- âœ… å¤šèµ„äº§ç±»åˆ«æ”¯æŒ (ç°é‡‘/åŠ å¯†è´§å¸/ç§¯åˆ†)
- âœ… TCC/SAGA åˆ†å¸ƒå¼äº‹åŠ¡

**éåŠŸèƒ½æ€§ç‰¹æ€§**:
- âœ… é«˜åå: è¯»å†™åˆ†ç¦»ï¼Œå…³é”®å†™è·¯å¾„æ— é”
- âœ… é«˜å¯ç”¨: åŸºäº Raft çš„å¤šå‰¯æœ¬é›†ç¾¤
- âœ… ä½å»¶è¿Ÿ: è®¡ç®—ä¸‹æ¨å­˜å‚¨å±‚
- âœ… æ°´å¹³æ‰©å±•: æ”¯æŒ Marker äº‹åŠ¡ç®¡ç†å™¨åˆ†ç‰‡

---

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 é¡¶å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Access Layer (è®¿é—®å±‚)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Payment Gateway                           â”‚   â”‚
â”‚  â”‚               (ä¸šåŠ¡è¯·æ±‚è½¬æ¢ + Leaderå‘ç°)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ gRPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Transaction Layer (äº‹åŠ¡å±‚ - Marker)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Transaction Manager (åˆ†å¸ƒå¼äº‹åŠ¡åè°ƒ)             â”‚   â”‚
â”‚  â”‚                   TCC / SAGA äº‹åŠ¡ç¼–æ’                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ gRPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Storage Layer (å­˜å‚¨å±‚ - Auticuro Command Side)        â”‚
â”‚                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Wallet Service Cluster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                               â”‚  â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚   â”‚    â”‚ Leader  â”‚â—„â”€â”€â”€â–ºâ”‚Follower1â”‚â—„â”€â”€â”€â–ºâ”‚Follower2â”‚              â”‚  â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚   â”‚         â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚  â”‚
â”‚   â”‚         â”‚          â”‚Follower3â”‚â—„â”€â”€â”€â–ºâ”‚Follower4â”‚              â”‚  â”‚
â”‚   â”‚         â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚  â”‚
â”‚   â”‚         â”‚              Raft Replication                      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                    Internal Components                       â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚
â”‚   â”‚  â”‚ tiny-mq  â”‚  â”‚ StateMachine â”‚  â”‚ MessageBroker â”‚         â”‚    â”‚
â”‚   â”‚  â”‚(Raft MQ) â”‚â”€â–ºâ”‚  (çŠ¶æ€æœº)    â”‚â”€â–ºâ”‚  (æ¶ˆæ¯åŒ¹é…)   â”‚         â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚   â”‚                       â”‚                                      â”‚    â”‚
â”‚   â”‚                â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                             â”‚    â”‚
â”‚   â”‚                â”‚   RocksDB    â”‚                             â”‚    â”‚
â”‚   â”‚                â”‚  (æŒä¹…åŒ–å±‚)  â”‚                             â”‚    â”‚
â”‚   â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ Event Stream
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Query Side (æŸ¥è¯¢ä¾§)                           â”‚
â”‚                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ Event Store â”‚â”€â”€â”€â–ºâ”‚Account Hierarchy â”‚    â”‚  Kafka         â”‚    â”‚
â”‚   â”‚ (PostgreSQL)â”‚    â”‚    Service       â”‚    â”‚  Connector     â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â”‚                                            â”‚             â”‚
â”‚          â–¼                                            â–¼             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚Account Queryâ”‚                            â”‚     Kafka      â”‚    â”‚
â”‚   â”‚   Service   â”‚                            â”‚   (ä¸‹æ¸¸è®¢é˜…)   â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 CQRS + Event Sourcing æ¶æ„

```
                    CQRS (Command Query Responsibility Segregation)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    Command Side (å†™)     â”‚         â”‚      Query Side (è¯»)         â”‚  â”‚
â”‚  â”‚                          â”‚         â”‚                              â”‚  â”‚
â”‚  â”‚  â€¢ æœ€å°åŒ–çŠ¶æ€å­˜å‚¨         â”‚         â”‚  â€¢ ç‰©åŒ–è§†å›¾ (Materialized)   â”‚  â”‚
â”‚  â”‚  â€¢ å®æ—¶ä½™é¢æ ¡éªŒ           â”‚         â”‚  â€¢ è´¦æˆ·å±‚çº§èšåˆ              â”‚  â”‚
â”‚  â”‚  â€¢ ç”Ÿæˆä¸å¯å˜äº‹ä»¶         â”‚  Event  â”‚  â€¢ å†å²æŸ¥è¯¢/åˆ†é¡µ             â”‚  â”‚
â”‚  â”‚  â€¢ é«˜ååä¼˜åŒ–            â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚  â€¢ OLAPåˆ†ææ”¯æŒ              â”‚  â”‚
â”‚  â”‚                          â”‚  Stream â”‚  â€¢ Read-Your-Writeä¸€è‡´æ€§     â”‚  â”‚
â”‚  â”‚  Rust + RocksDB          â”‚         â”‚  PostgreSQL + å¤šè§†å›¾         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                          â”‚   Event Store   â”‚                           â”‚
â”‚                          â”‚ (Golden Source) â”‚                           â”‚
â”‚                          â”‚   äº‹ä»¶å³çœŸç›¸     â”‚                           â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ ¸å¿ƒæ¨¡å—è¯´æ˜

| æ¨¡å—è·¯å¾„ | æ¨¡å—åç§° | æ ¸å¿ƒèŒè´£ | å…³é”®æ–‡ä»¶ |
|:---|:---|:---|:---|
| `firm-wallet-service/` | **é’±åŒ…æ ¸å¿ƒæœåŠ¡** | è´¦æˆ·ç®¡ç†ã€ä½™é¢æ“ä½œã€çŠ¶æ€æœº | `service.rs`, `state_machine.rs`, `account.rs` |
| `firm-wallet-gateway/` | **ç½‘å…³æœåŠ¡** | Leader å‘ç°ã€è¯·æ±‚è·¯ç”±ã€æ•…éšœè½¬ç§» | `firm_wallet_gateway.rs` |
| `dependencies/tiny-mq/` | **Raft æ¶ˆæ¯é˜Ÿåˆ—** | å…±è¯†å¤åˆ¶ã€æ—¥å¿—å­˜å‚¨ã€Leaderé€‰ä¸¾ | `message_queue_adapter.rs`, `peer.rs` |
| `dependencies/hologram-protos/` | **åè®®å®šä¹‰** | gRPC æ¥å£ã€æ•°æ®æ¨¡å‹å®šä¹‰ | `*.proto` |
| `dependencies/infra-common/` | **åŸºç¡€è®¾æ–½** | ç½‘å…³æ¡†æ¶ã€PostgreSQL å·¥å…· | `gateway_framework/` |

### 2.4 Workspace ç»“æ„

```
Auticuro/
â”œâ”€â”€ Cargo.toml                    # Workspace æ ¹é…ç½®
â”œâ”€â”€ firm-wallet-service/          # ğŸ¯ æ ¸å¿ƒé’±åŒ…æœåŠ¡
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.rs               # å…¥å£ç‚¹
â”‚   â”‚   â”œâ”€â”€ service.rs            # gRPC æœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ state_machine.rs      # çŠ¶æ€æœº (æ ¸å¿ƒé€»è¾‘)
â”‚   â”‚   â”œâ”€â”€ message_broker.rs     # è¯·æ±‚-å“åº”åŒ¹é…å™¨
â”‚   â”‚   â”œâ”€â”€ account.rs            # è´¦æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ balance_calculator.rs # é«˜ç²¾åº¦ä½™é¢è®¡ç®—
â”‚   â”‚   â”œâ”€â”€ rocksdb_state.rs      # æŒä¹…åŒ–å±‚
â”‚   â”‚   â”œâ”€â”€ internal.rs           # Command/Event å°è£…
â”‚   â”‚   â”œâ”€â”€ errors/               # é”™è¯¯ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ Cargo.toml
â”œâ”€â”€ firm-wallet-gateway/          # ğŸŒ API ç½‘å…³
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.rs
â”‚   â”‚   â””â”€â”€ firm_wallet_gateway.rs
â”‚   â””â”€â”€ Cargo.toml
â”œâ”€â”€ dependencies/
â”‚   â”œâ”€â”€ tiny-mq/                  # ğŸ“¨ Raft æ¶ˆæ¯é˜Ÿåˆ— (åŸºäº raft-rs)
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ message_queue_adapter.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ peer.rs           # Raft èŠ‚ç‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ store.rs          # Raft å­˜å‚¨
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ Cargo.toml
â”‚   â”œâ”€â”€ hologram-protos/          # ğŸ“ Protocol Buffers å®šä¹‰
â”‚   â”‚   â””â”€â”€ src/proto/
â”‚   â”‚       â””â”€â”€ firm_wallet/
â”‚   â”‚           â”œâ”€â”€ accountpb.proto
â”‚   â”‚           â”œâ”€â”€ balance_operation_servicepb.proto
â”‚   â”‚           â”œâ”€â”€ account_management_servicepb.proto
â”‚   â”‚           â””â”€â”€ internal_servicepb.proto
â”‚   â””â”€â”€ infra-common/             # ğŸ”§ å…¬å…±åŸºç¡€è®¾æ–½
â””â”€â”€ auticuro-documentation/       # ğŸ“š æ–‡æ¡£ç«™ç‚¹ (Docusaurus)
```

---

## 3. å…³é”®æµç¨‹åˆ†æ

### 3.1 è½¬è´¦è¯·æ±‚å¤„ç†æµç¨‹ (å››çº¿ç¨‹åä½œ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TransferRequest å¤„ç†æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client          Thread 1           Raft Log        Thread 2        Thread 3        Thread 4
  â”‚             (gRPC)            (tiny-mq)      (LogConsumer)   (StateMachine)  (MessageBroker)
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚ TransferReq    â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚  send_payload()  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚    Raftå…±è¯†      â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚    (å¤šæ•°èŠ‚ç‚¹)    â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚ (log_index,      â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚  offset)         â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚          register(Position, oneshot_tx)         â”‚               â”‚
  â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚  poll()       â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚  Entry        â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚  SPSC Channel â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚ 1.å»é‡æ£€æŸ¥    â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚ 2.ä½™é¢æ ¡éªŒ    â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚ 3.çŠ¶æ€æ›´æ–°    â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚ 4.ç”ŸæˆEvent   â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚ 5.æŒä¹…åŒ–      â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚ register(Position, Event)
  â”‚                â”‚                  â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚    match()    â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                â”‚                  Event via oneshot_rx            â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚ TransferResp   â”‚                  â”‚               â”‚               â”‚               â”‚
  â”‚                â”‚                  â”‚               â”‚               â”‚               â”‚
```

### 3.2 å››çº¿ç¨‹æ¨¡å‹è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            å››çº¿ç¨‹åä½œæ¨¡å‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Thread 1: gRPC Thread (å‰å°çº¿ç¨‹)                                     â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
â”‚  â”‚  èŒè´£: æ¥æ”¶è¯·æ±‚ â†’ æäº¤åˆ° Raft â†’ æ³¨å†Œç­‰å¾… â†’ è¿”å›å“åº”                   â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  [Accept Request] â†’ [Append Raft Log] â†’ [Wait Commit]                â”‚  â”‚
â”‚  â”‚         â”‚                                     â”‚                       â”‚  â”‚
â”‚  â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚
â”‚  â”‚         â–¼              â–¼                                              â”‚  â”‚
â”‚  â”‚  [Register to MessageBroker] â†’ [Await oneshot] â†’ [Reply to Client]   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                              â–²               â”‚
â”‚                              â”‚ Raft Log                     â”‚ oneshot       â”‚
â”‚                              â–¼                              â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Thread 2: Log Consumer (æ—¥å¿—æ¶ˆè´¹çº¿ç¨‹)                                â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
â”‚  â”‚  èŒè´£: è½®è¯¢å·²æäº¤æ—¥å¿— â†’ ååºåˆ—åŒ– â†’ å‘é€åˆ°çŠ¶æ€æœº                       â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  loop {                                                               â”‚  â”‚
â”‚  â”‚      entries = poll_committed_entries(log_index..applied_index);     â”‚  â”‚
â”‚  â”‚      for entry in entries {                                          â”‚  â”‚
â”‚  â”‚          spsc_sender.send(parse(entry));                             â”‚  â”‚
â”‚  â”‚      }                                                                â”‚  â”‚
â”‚  â”‚  }                                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â”‚ SPSC Channel                                 â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Thread 3: StateMachine (çŠ¶æ€æœºçº¿ç¨‹ - ğŸ”¥ æ— é”å…³é”®è·¯å¾„)                â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
â”‚  â”‚  èŒè´£: æ‰§è¡Œä¸šåŠ¡é€»è¾‘ â†’ æ›´æ–°çŠ¶æ€ â†’ ç”Ÿæˆäº‹ä»¶ â†’ æŒä¹…åŒ–                    â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  [Receive Command] â†’ [Dedup Check] â†’ [Validate Balance]              â”‚  â”‚
â”‚  â”‚         â”‚                                     â”‚                       â”‚  â”‚
â”‚  â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚
â”‚  â”‚         â–¼              â–¼                                              â”‚  â”‚
â”‚  â”‚  [Update In-Memory State] â†’ [Generate Event] â†’ [Batch Write RocksDB] â”‚  â”‚
â”‚  â”‚                                     â”‚                                 â”‚  â”‚
â”‚  â”‚                                     â–¼                                 â”‚  â”‚
â”‚  â”‚                          [Register Event to Broker]                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â”‚ mpsc Channel                                 â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Thread 4: MessageBroker (æ¶ˆæ¯ä»£ç†çº¿ç¨‹)                               â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
â”‚  â”‚  èŒè´£: åŒ¹é…è¯·æ±‚ä¸å“åº” â†’ è¶…æ—¶å¤„ç† â†’ GC                                 â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  loop {                                                               â”‚  â”‚
â”‚  â”‚      requests = batch_recv(inflight_request_rx);                     â”‚  â”‚
â”‚  â”‚      events = batch_recv(inflight_event_rx);                         â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚      // åŒ¹é…: Position(log_index, offset) ä½œä¸º Key                   â”‚  â”‚
â”‚  â”‚      for req in requests {                                           â”‚  â”‚
â”‚  â”‚          if event = events.remove(req.position) {                    â”‚  â”‚
â”‚  â”‚              req.oneshot_tx.send(event);                             â”‚  â”‚
â”‚  â”‚          } else {                                                     â”‚  â”‚
â”‚  â”‚              pending_requests.insert(req);                           â”‚  â”‚
â”‚  â”‚          }                                                            â”‚  â”‚
â”‚  â”‚      }                                                                â”‚  â”‚
â”‚  â”‚      gc_timeout_requests();                                          â”‚  â”‚
â”‚  â”‚  }                                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 è¯·æ±‚å»é‡ä¸å¹‚ç­‰æ€§ä¿è¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å¹‚ç­‰æ€§ä¿è¯æœºåˆ¶                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   Request æºå¸¦ dedup_id (ç”±å®¢æˆ·ç«¯ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†)                             â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  StateMachine.handle_command()                                       â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚  1. æŸ¥æ‰¾ dedup_id â†’ seq_num æ˜ å°„                                     â”‚   â”‚
â”‚   â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚     â”‚  if let Some(seq_num) = get_seq_num(dedup_id) {             â”‚ â”‚   â”‚
â”‚   â”‚     â”‚      // é‡å¤è¯·æ±‚! è¿”å›ä¹‹å‰ç”Ÿæˆçš„ Event                        â”‚ â”‚   â”‚
â”‚   â”‚     â”‚      let event = get_event(seq_num);                        â”‚ â”‚   â”‚
â”‚   â”‚     â”‚      return Ok(event);                                       â”‚ â”‚   â”‚
â”‚   â”‚     â”‚  }                                                           â”‚ â”‚   â”‚
â”‚   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚  2. é¦–æ¬¡è¯·æ±‚ â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘                                          â”‚   â”‚
â”‚   â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚     â”‚  let event = execute_business_logic(command);               â”‚ â”‚   â”‚
â”‚   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚  3. æŒä¹…åŒ–æ˜ å°„å…³ç³» (åŸå­å†™å…¥ RocksDB WriteBatch)                      â”‚   â”‚
â”‚   â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚     â”‚  // Map 1: dedup_id â†’ seq_num                               â”‚ â”‚   â”‚
â”‚   â”‚     â”‚  wb.put(dedup_key(dedup_id), seq_num.to_bytes());           â”‚ â”‚   â”‚
â”‚   â”‚     â”‚                                                              â”‚ â”‚   â”‚
â”‚   â”‚     â”‚  // Map 2: seq_num â†’ Event                                  â”‚ â”‚   â”‚
â”‚   â”‚     â”‚  wb.put(event_key(seq_num), event.to_bytes());              â”‚ â”‚   â”‚
â”‚   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚   âœ… ä¿è¯: ç›¸åŒ dedup_id çš„è¯·æ±‚æ°¸è¿œè¿”å›ç›¸åŒç»“æœ                              â”‚
â”‚   âœ… ä¿è¯: Event åºåˆ—å·å…¨å±€é€’å¢ä¸”è¿ç»­ï¼Œä¾¿äºä¸‹æ¸¸å®Œæ•´æ€§æ ¡éªŒ                    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. æºç çº§è®¾è®¡äº®ç‚¹

### 4.1 è®¾è®¡æ¨¡å¼åˆ†æ

#### 4.1.1 Copy-On-Write æ¨¡å¼ (è´¦æˆ·çŠ¶æ€æ›´æ–°)

**ä»£ç ä½ç½®**: `firm-wallet-service/src/account.rs`

```rust
/// All the account update methods follow the Copy-On-Write pattern
impl Account {
    pub fn increase_balance_by(
        &self,
        amount: &str,
        calculator: &BalanceCalculator,
    ) -> GeneralResult<(Self, BalanceChange)> {
        self.assert_state_is_normal()?;

        // 1. Clone first
        let mut new_account = self.clone();
        
        // 2. Validate on clone
        let new_balance = calculator.add(new_account.get_balance().get_available(), amount)?;
        new_account.validate_balance_limitation(&new_balance, calculator)?;
        
        // 3. Modify clone (original unchanged)
        new_account.0.mut_balance().set_available(new_balance);

        Ok((new_account, balance_change))
    }
}
```

**è®¾è®¡åŸç†**:
- æ‰€æœ‰æ›´æ–°æ“ä½œå…ˆå…‹éš†å½“å‰çŠ¶æ€
- åœ¨å…‹éš†å‰¯æœ¬ä¸Šæ‰§è¡ŒéªŒè¯å’Œä¿®æ”¹
- éªŒè¯å¤±è´¥åˆ™ä¸¢å¼ƒå‰¯æœ¬ï¼ŒåŸçŠ¶æ€ä¸å˜
- å®ç°æ‰¹é‡æ“ä½œçš„ **All-or-Nothing** è¯­ä¹‰

#### 4.1.2 çŠ¶æ€æœºæ¨¡å¼ (æ ¸å¿ƒä¸šåŠ¡å¤„ç†)

**ä»£ç ä½ç½®**: `firm-wallet-service/src/state_machine.rs`

```rust
fn handle_command(&mut self, context: &mut ApplyContext, log_index: u64, offset: u64, command: Command) {
    // 1. å»é‡æ£€æŸ¥
    if let Some(event) = self.maybe_handle_duplicate_command(&command) {
        context.send_event(position, event);
        return;
    }

    // 2. æ¨¡å¼åŒ¹é…åˆ†æ´¾åˆ°å…·ä½“å¤„ç†å™¨
    let res = match command.payload().clone() {
        transfer_request(req) => self.handle_transfer(context, req, log_index, offset),
        reserve_request(req) => self.handle_reserve(context, req, log_index, offset),
        release_request(req) => self.handle_release(context, req, log_index, offset),
        batch_balance_operation_request(req) => self.handle_batch_balance_operation(...),
        create_account_request(req) => self.handle_create_account(...),
        lock_account_request(req) => self.handle_lock_account(...),
        unlock_account_request(req) => self.handle_unlock_account(...),
        delete_account_request(req) => self.handle_delete_account(...),
        update_account_config_request(req) => self.handle_update_account_config(...),
    };

    // 3. ç”Ÿæˆå¹¶æŒä¹…åŒ–äº‹ä»¶
    match res {
        Ok(mut event) => {
            event.set_header(command.header().clone(), log_index, offset, self.last_seq_num);
            self.update_seq_num_and_event(context, command.command_id(), event_pb);
            context.send_event(position, Ok(event_pb));
        }
        Err(e) => context.send_event(position, Err(e)),
    }
}
```

#### 4.1.3 ä¸­ä»‹è€…æ¨¡å¼ (MessageBroker)

**ä»£ç ä½ç½®**: `firm-wallet-service/src/message_broker.rs`

```rust
pub struct MessageBroker {
    // ç­‰å¾…åŒ¹é…äº‹ä»¶çš„è¯·æ±‚ (æ¥è‡ª gRPC çº¿ç¨‹)
    inflight_requests: BTreeMap<Position, (Instant, oneshot::Sender<InflightEvent>)>,

    // ç­‰å¾…åŒ¹é…è¯·æ±‚çš„äº‹ä»¶ (æ¥è‡ª StateMachine çº¿ç¨‹)
    inflight_events: BTreeMap<Position, InflightEvent>,

    inflight_request_rx: mpsc::Receiver<InflightRequest>,
    inflight_event_rx: mpsc::Receiver<InflightEvent>,
}

impl MessageBroker {
    pub fn run(&mut self) {
        loop {
            // Step 1: å¤„ç†æ–°è¯·æ±‚
            for req in batch_recv(&self.inflight_request_rx) {
                match self.inflight_events.remove(&req.position) {
                    Some(event) => req.resp_to.send(event),  // ç«‹å³åŒ¹é…
                    None => self.register_inflight_request(req),  // ç­‰å¾…
                }
            }

            // Step 2: å¤„ç†æ–°äº‹ä»¶
            for event in batch_recv(&self.inflight_event_rx) {
                match self.inflight_requests.remove(&event.position) {
                    Some((_, sender)) => sender.send(event),  // ç«‹å³åŒ¹é…
                    None => self.register_inflight_event(event),  // ç­‰å¾…
                }
            }

            // Step 3: è¶…æ—¶æ¸…ç†
            self.gc_inflight_requests();  // 1ç§’è¶…æ—¶
            self.gc_inflight_events();    // 10000æ¡ä¸Šé™
        }
    }
}
```

#### 4.1.4 ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ (LogConsumer)

**ä»£ç ä½ç½®**: `dependencies/tiny-mq/src/message_queue_adapter.rs`

```rust
pub struct LogConsumer<F, T> {
    message_queue: Arc<MessageQueueAdapter>,
    log_index: u64,
    log_entry_parser: F,
    sender: SyncSender<LogEntry<T>>,
}

impl<F, T> LogConsumer<F, T> {
    pub fn run(message_queue: Arc<MessageQueueAdapter>, log_index: u64, parser: F) -> LogEntryReceiver<T> {
        let (sender, receiver) = sync_channel(buffer_size);
        
        thread::spawn(move || {
            loop {
                let (start_index, applied_index) = message_queue.get_start_index_and_applied_index();
                
                if log_index > applied_index {
                    thread::sleep(Duration::from_micros(500));  // Backpressure
                    continue;
                }

                let entries = message_queue.get_range(log_index, end, parser);
                for (index, messages) in entries {
                    sender.send(LogEntry::new(index, messages)).unwrap();
                }
                log_index = end + 1;
            }
        });

        LogEntryReceiver(receiver)
    }
}
```

### 4.2 å…³é”®æ•°æ®ç»“æ„

#### 4.2.1 è´¦æˆ·æ¨¡å‹ (Protocol Buffers)

```protobuf
// æ–‡ä»¶: dependencies/hologram-protos/src/proto/firm_wallet/accountpb.proto

message Account {
  AccountConfig config = 1;    // é…ç½® (èµ„äº§ç±»åˆ«ã€ä½™é¢é™åˆ¶)
  Balance balance = 2;         // ä½™é¢ (å¯ç”¨ + é¢„ç•™)
  AccountState state = 3;      // çŠ¶æ€ (Normal/Locked/Deleted)
  string account_id = 4;       // å”¯ä¸€æ ‡è¯†
}

message Balance {
  string available = 1;                      // å¯ç”¨ä½™é¢ (é«˜ç²¾åº¦å­—ç¬¦ä¸²)
  map<string, string> reservations = 2;      // reservation_id â†’ é¢„ç•™é‡‘é¢
}

message AccountConfig {
  BalanceLimit balance_limit = 1;            // ä¸Šä¸‹é™
  AssetClass asset_class = 2;                // èµ„äº§ç±»åˆ« (Cash/Crypto/Coupon)
}

enum AccountState {
  InvalidState = 0;
  Deleted = 1;
  Locked = 2;     // å†»ç»“ (ä¸å¯è½¬è´¦ï¼Œå¯è§£å†»)
  Normal = 3;     // æ­£å¸¸ (å¯æ“ä½œ)
}
```

#### 4.2.2 è´¦æˆ·çŠ¶æ€è½¬æ¢

```
                    Account State Machine
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                             â”‚
    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
    â”‚         â”‚                     â”‚             â”‚
    â”‚         â–¼                     â”‚             â”‚
    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”    lock()    â”Œâ”€â”€â”€â”€â”€â”€â”        â”‚
    â”‚      â”‚Normalâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Lockedâ”‚        â”‚
    â”‚      â””â”€â”€â”¬â”€â”€â”€â”˜â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”˜        â”‚
    â”‚         â”‚       unlock()                    â”‚
    â”‚         â”‚                                   â”‚
    â”‚         â”‚ delete()                          â”‚
    â”‚         â”‚ (ä½™é¢å¿…é¡»ä¸º0)                      â”‚
    â”‚         â–¼                                   â”‚
    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”                              â”‚
    â”‚      â”‚Deletedâ”‚  (ç»ˆæ€ï¼Œä¸å¯æ¢å¤)             â”‚
    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
    â”‚                                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```rust
// çŠ¶æ€è½¬æ¢çŸ©é˜µå®šä¹‰
lazy_static! {
    static ref LEGAL_TRANSITIONS: HashMap<AccountState, HashSet<AccountState>> = {
        let mut m = HashMap::new();
        m.insert(Normal, HashSet::from([Locked, Deleted]));
        m.insert(Locked, HashSet::from([Normal]));
        // Deleted æ˜¯ç»ˆæ€ï¼Œæ— å‡ºè¾¹
        m
    };
}
```

### 4.3 æ‰¹é‡å†™å…¥ä¼˜åŒ–

**ä»£ç ä½ç½®**: `firm-wallet-service/src/state_machine.rs`

```rust
pub fn maybe_flush(&mut self, context: &mut ApplyContext) {
    if self.should_flush(context) {
        self.flush(context);
    }
}

fn should_flush(&self, context: &ApplyContext) -> bool {
    // ç­–ç•¥1: ç´¯ç§¯è¶³å¤Ÿæ›´æ–° (é»˜è®¤100æ¡)
    if self.applied_index - context.flushed_applied_index >= context.batch_size {
        return true;
    }
    // ç­–ç•¥2: å®šæœŸåˆ·æ–° (æ¯100ms)
    if duration_to_ms(context.flushed_timestamp.elapsed()) > 100 {
        return true;
    }
    false
}

fn flush(&mut self, context: &mut ApplyContext) {
    // éåŒæ­¥å†™ (Raftå·²ä¿è¯æŒä¹…åŒ–)
    context.wb.write_opt(false);
    context.wb.clear();
    
    // æ¸…ç†å·²åˆ é™¤è´¦æˆ·
    for id in mem::take(&mut context.to_be_deleted_account_ids) {
        self.accounts.remove(&id);
    }
    
    // æ¸…ç†ç¼“å­˜
    self.event_cache.clear();
    self.seq_num_cache.clear();
    
    context.flushed_applied_index = self.applied_index;
    context.flushed_timestamp = Instant::now_coarse();
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- å‡å°‘ç£ç›˜ I/O æ¬¡æ•° (æ‰¹é‡å†™å…¥)
- æ— éœ€ `fsync` (Raft å·²ä¿è¯å¤šæ•°èŠ‚ç‚¹æŒä¹…åŒ–)
- å†…å­˜ç¼“å­˜åŠ é€Ÿå»é‡æŸ¥è¯¢

### 4.4 RocksDB çŠ¶æ€ç®¡ç†

**ä»£ç ä½ç½®**: `firm-wallet-service/src/rocksdb_state.rs`

```rust
pub struct RocksDBState {
    db: RocksEngine,
}

// æŒä¹…åŒ–çš„ç¡¬çŠ¶æ€
pub const APPLIED_INDEX: HardStateKind = HardStateKind {
    default_value: 5,  // Raft log index èµ·å§‹å€¼
    key: "applied_index",
};

pub const PERSISTED_LAST_SEQ_NUM: HardStateKind = HardStateKind {
    default_value: 0,
    key: "last_seq_num",
};

pub const PERSISTED_FIRST_SEQ_NUM: HardStateKind = HardStateKind {
    default_value: 0,
    key: "first_seq_num",
};

impl RocksDBState {
    /// ä» RocksDB æ¢å¤å…¨éƒ¨è´¦æˆ·åˆ°å†…å­˜
    pub fn read_accounts_from_db(&self) -> HashMap<String, Account> {
        let mut accounts = HashMap::new();
        self.db.scan(DATA_MIN_KEY, DATA_MAX_KEY, false, |key, value| {
            let account_id = String::from_utf8(keys::origin_data_key(key).to_owned()).unwrap();
            let account = Account::from_proto(AccountPb::parse_from_bytes(value).unwrap());
            accounts.insert(account_id, account);
            Ok(true)
        }).unwrap();
        accounts
    }
}
```

**å­˜å‚¨å¸ƒå±€**:

| Key ç±»å‹ | Key æ ¼å¼ | Value |
|----------|----------|-------|
| è´¦æˆ·æ•°æ® | `data:{account_id}` | Account protobuf |
| å»é‡æ˜ å°„ | `dedup:{command_id}` | seq_num (8 bytes) |
| äº‹ä»¶æ—¥å¿— | `event:{seq_num}` | Event protobuf |
| å…ƒæ•°æ® | `applied_index` | u64 |
| å…ƒæ•°æ® | `last_seq_num` | u64 |
| å…ƒæ•°æ® | `first_seq_num` | u64 |

---

## 5. æŠ€æœ¯æ ˆæ€»ç»“

| å±‚æ¬¡ | æŠ€æœ¯é€‰å‹ | é€‰å‹ç†ç”± |
|:---|:---|:---|
| **ç¼–ç¨‹è¯­è¨€** | Rust | å†…å­˜å®‰å…¨ã€é›¶æˆæœ¬æŠ½è±¡ã€æ—  GC åœé¡¿ã€é«˜æ€§èƒ½ |
| **RPC æ¡†æ¶** | gRPC (grpcio + tonic) | é«˜æ€§èƒ½ã€å¼ºç±»å‹ã€è·¨è¯­è¨€ã€HTTP/2 |
| **å…±è¯†ç®—æ³•** | Raft (raft-rs) | æ˜“ç†è§£ã€å·¥ç¨‹æˆç†Ÿã€TiKV ç”Ÿäº§éªŒè¯ |
| **å­˜å‚¨å¼•æ“** | RocksDB | LSM-Treeã€é«˜å†™å…¥ååã€å‹ç¼©ä¼˜åŒ– |
| **åºåˆ—åŒ–** | Protocol Buffers | ç´§å‡‘ç¼–ç ã€å‘åå…¼å®¹ã€ä»£ç ç”Ÿæˆ |
| **å¼‚æ­¥è¿è¡Œæ—¶** | Futures + Channel | é«˜æ•ˆäº‹ä»¶é©±åŠ¨ã€é›¶æ‹·è´é€šä¿¡ |
| **ç›‘æ§æŒ‡æ ‡** | Prometheus | æ ‡å‡†åŒ–ã€Grafana é›†æˆ |
| **æ–‡æ¡£ç«™ç‚¹** | Docusaurus | React é©±åŠ¨ã€Markdown æ”¯æŒ |

### 5.1 æ ¸å¿ƒä¾èµ–å…³ç³»

```
firm-wallet-service
    â”œâ”€â”€ hologram-protos (gRPC æ¥å£å®šä¹‰)
    â”œâ”€â”€ tiny-mq (Raft æ¶ˆæ¯é˜Ÿåˆ—)
    â”‚   â”œâ”€â”€ raft-rs (Raft å…±è¯†å®ç°)
    â”‚   â””â”€â”€ rocksdb (Raft æ—¥å¿—å­˜å‚¨)
    â”œâ”€â”€ tikv-util (å·¥å…·åº“: æ—¥å¿—ã€æ—¶é—´ã€æŒ‡æ ‡)
    â””â”€â”€ grpcio (gRPC æœåŠ¡ç«¯)

firm-wallet-gateway
    â”œâ”€â”€ hologram-protos
    â”œâ”€â”€ gateway-framework (é€šç”¨ç½‘å…³æ¡†æ¶)
    â””â”€â”€ tonic (gRPC å®¢æˆ·ç«¯)
```

---

## 6. æ€»ç»“ä¸å¯ç¤º

### 6.1 æ¶æ„è®¾è®¡æœ€å€¼å¾—å€Ÿé‰´çš„ 3 ä¸ªç‚¹

#### 1ï¸âƒ£ å•çº¿ç¨‹æ— é”å…³é”®è·¯å¾„ (LMAX Disruptor é£æ ¼)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼ ç»Ÿå¤šçº¿ç¨‹æ–¹æ¡ˆ                 Auticuro æ–¹æ¡ˆ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è´¦æˆ·Aé” â†’ è½¬è´¦ â†’ è§£é”          å•çº¿ç¨‹é¡ºåºå¤„ç†æ‰€æœ‰è´¦æˆ·æ“ä½œ       â”‚
â”‚  è´¦æˆ·Bé” â†’ ...                  æ— é”ç«äº‰ï¼Œç¡®å®šæ€§æ‰§è¡Œ             â”‚
â”‚  æ­»é”é£é™© âœ—                     å¯é¢„æµ‹å»¶è¿Ÿ âœ“                    â”‚
â”‚  è°ƒè¯•å›°éš¾ âœ—                     æ˜“äºæ¨ç†å’Œæµ‹è¯• âœ“                â”‚
â”‚  å¤æ‚åº¦é«˜ âœ—                     å®ç°ç®€æ´ âœ“                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯ç¤º**: å¯¹äºå†™å…¥å¯†é›†å‹ä¸šåŠ¡ï¼Œå•çº¿ç¨‹ + æ‰¹é‡å¤„ç†å¾€å¾€ä¼˜äºå¤æ‚çš„å¹¶å‘æ§åˆ¶ã€‚é€šè¿‡æ¶ˆé™¤é”ç«äº‰ï¼Œè·å¾—æ›´å¯é¢„æµ‹çš„å»¶è¿Ÿåˆ†å¸ƒã€‚

#### 2ï¸âƒ£ CQRS + Event Sourcing çš„å·¥ç¨‹åŒ–è½åœ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Command Side (é«˜æ€§èƒ½å†™å…¥)        Query Side (çµæ´»æŸ¥è¯¢)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ æœ€å°åŒ–çŠ¶æ€å­˜å‚¨                 â€¢ å¤šç§ç‰©åŒ–è§†å›¾                 â”‚
â”‚  â€¢ ä»…å®æ—¶ä½™é¢æ ¡éªŒ                 â€¢ è´¦æˆ·å±‚çº§èšåˆ                 â”‚
â”‚  â€¢ ç”Ÿæˆä¸å¯å˜äº‹ä»¶æµ               â€¢ å†å²æŸ¥è¯¢/åˆ†é¡µ                â”‚
â”‚  â€¢ ä¼˜åŒ–å†™å…¥è·¯å¾„                   â€¢ OLAP åˆ†ææ”¯æŒ               â”‚
â”‚                                                                  â”‚
â”‚                     â†“ Event Stream â†“                            â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                  â”‚    Event Store      â”‚                        â”‚
â”‚                  â”‚  (Golden Source)    â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯ç¤º**: è¯»å†™åˆ†ç¦»ä¸ä»…æ˜¯æŠ€æœ¯ä¼˜åŒ–ï¼Œæ›´æ˜¯ä¸šåŠ¡è§£è€¦ã€‚Event Store ä½œä¸º Single Source of Truthï¼Œå…è®¸è¯»å†™ä¾§ç‹¬ç«‹æ¼”è¿›ã€ç‹¬ç«‹æ‰©å±•ã€‚

#### 3ï¸âƒ£ ä¸‰å±‚è§£è€¦æ¶æ„ (Access â†’ Transaction â†’ Storage)

| å±‚ | ç‰¹ç‚¹ | æ‰©å±•æ–¹å¼ | æ•…éšœéš”ç¦» |
|:---|:---|:---|:---|
| Access Layer | ä¸šåŠ¡é€‚é…ï¼Œæ— çŠ¶æ€ | æ°´å¹³æ‰©å±• Pod | å¿«é€Ÿé‡å¯ |
| Transaction Layer | åˆ†å¸ƒå¼äº‹åŠ¡åè°ƒ | æŒ‰æµé‡æ‰©å±•åˆ†ç‰‡ | äº‹åŠ¡å›æ»š |
| Storage Layer | æ•°æ®æŒä¹…åŒ– | æŒ‰è´¦æˆ·é‡åˆ†ç‰‡ | Raft æ•…éšœè½¬ç§» |

**å¯ç¤º**: 
- è®¡ç®—å¯†é›†å‹ï¼ˆäº‹åŠ¡åè°ƒï¼‰å’Œæ•°æ®å¯†é›†å‹ï¼ˆè´¦æˆ·å­˜å‚¨ï¼‰åˆ†ç¦»
- é¿å…è€¦åˆå¯¼è‡´çš„æ‰©å±•ç“¶é¢ˆ
- å„å±‚å¯é‡‡ç”¨ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥

### 6.2 è®¾è®¡æƒè¡¡ä¸æ½œåœ¨æ”¹è¿›

| å½“å‰è®¾è®¡ | æƒè¡¡è€ƒé‡ | æ½œåœ¨æ”¹è¿›æ–¹å‘ |
|:---|:---|:---|
| å• Raft é›†ç¾¤ | ç®€åŒ–å®ç°ï¼Œé¿å…åˆ†å¸ƒå¼äº‹åŠ¡å¤æ‚æ€§ | åŸºäºè´¦æˆ· ID åˆ†ç‰‡ï¼Œæå‡å®¹é‡ä¸Šé™ |
| å†…å­˜å…¨é‡è´¦æˆ· | ä½å»¶è¿Ÿè®¿é—® | å†·çƒ­åˆ†ç¦»ï¼Œæ”¯æŒæµ·é‡è´¦æˆ· |
| RocksDB æ—  fsync | ä¾èµ– Raft ä¿è¯ï¼Œæå‡æ€§èƒ½ | å¯é…ç½®åˆ·ç›˜ç­–ç•¥ |
| Query Side æœªå¼€æº | ä¸“æ³¨æ ¸å¿ƒèƒ½åŠ› | è®¡åˆ’å¼€æºå®Œæ•´ç”Ÿæ€ |

### 6.3 é€‚ç”¨åœºæ™¯åˆ¤æ–­

**âœ… é€‚åˆä½¿ç”¨ Auticuro çš„åœºæ™¯**:
- é‡‘èçº§ä¸€è‡´æ€§è¦æ±‚ (é“¶è¡Œã€æ”¯ä»˜ã€æ¸…ç»“ç®—)
- é«˜ååå†™å…¥ (10K+ TPS)
- éœ€è¦å®Œæ•´å®¡è®¡æ—¥å¿— (åˆè§„è¦æ±‚)
- è´¦æˆ·æ•°é‡å¯æ§ (å•åˆ†ç‰‡ ~ç™¾ä¸‡çº§)

**âš ï¸ éœ€è¦è¯„ä¼°çš„åœºæ™¯**:
- è¶…å¤§è§„æ¨¡è´¦æˆ· (éœ€è¦å¤šåˆ†ç‰‡ + Marker äº‹åŠ¡å±‚)
- å¤æ‚æŸ¥è¯¢éœ€æ±‚ (éœ€è¦æ„å»º Query Side)
- è·¨åœ°åŸŸéƒ¨ç½² (Raft å¯¹ç½‘ç»œå»¶è¿Ÿæ•æ„Ÿ)

---

## é™„å½•

### A. æ ¸å¿ƒ API ä¸€è§ˆ

| æœåŠ¡ | æ–¹æ³• | æè¿° |
|:---|:---|:---|
| `BalanceOperationService` | `Transfer` | åŒè¾¹è½¬è´¦ |
| | `BatchBalanceOperation` | æ‰¹é‡ä½™é¢æ“ä½œ |
| | `Reserve` | é¢„ç•™ä½™é¢ |
| | `Release` | é‡Šæ”¾é¢„ç•™ |
| | `QueryBalance` | æŸ¥è¯¢ä½™é¢ |
| `AccountManagementService` | `CreateAccount` | åˆ›å»ºè´¦æˆ· |
| | `DeleteAccount` | åˆ é™¤è´¦æˆ· |
| | `LockAccount` | é”å®šè´¦æˆ· |
| | `UnlockAccount` | è§£é”è´¦æˆ· |
| | `UpdateAccountConfig` | æ›´æ–°é…ç½® |
| | `GetAccount` | è·å–è´¦æˆ·ä¿¡æ¯ |
| `InternalService` | `QueryEvents` | æŸ¥è¯¢äº‹ä»¶æµ |

### B. å‚è€ƒé“¾æ¥

- é¡¹ç›® README: `/README.md`
- æ¶æ„è®¾è®¡æ–‡æ¡£: `/auticuro-documentation/docs/Design/`
- API æ–‡æ¡£: `/auticuro-documentation/docs/API Doc/`
- å¿«é€Ÿå¼€å§‹: `/docs/quickstart.md`
- é…ç½®è¯´æ˜: `/docs/configuration.md`

---

> **æ–‡æ¡£ç”Ÿæˆ**: Claude AI  
> **æœ€åæ›´æ–°**: 2025å¹´12æœˆ11æ—¥

